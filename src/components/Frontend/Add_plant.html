<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet App - Add New Plant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.5s, color 0.5s; }
        /* Reuse scrollbar styles from dashboard.html */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: rgba(45, 68, 53, 0.5); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(214, 228, 209, 0.2); }
    </style>
    <script type="text/javascript">

        // Custom Tailwind configuration (copied)
        tailwind.config = {
            darkMode: 'class', theme: { extend: { colors: {
                'forest-dark': '#0F1D13', 'forest-text': '#1A3320', 'sage-green': '#A8C999',
                'sage-light': '#D6E4D1', 'cream-light': '#F8F9F5', 'wood-dark': '#4F3A2C',
                'wood-light': '#E0DCD7',
            }, boxShadow: { 'soft': '0 8px 30px rgba(0, 0, 0, 0.05)', 'soft-dark': '0 8px 30px rgba(255, 255, 255, 0.05)' } } }
        }

        // --- Core Add Plant Logic ---
       document.addEventListener('DOMContentLoaded', () => {
    const htmlEl = document.documentElement;
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');

    const searchField = document.getElementById('species-search');
    const plantList = document.getElementById('plant-options');
    const waterField = document.getElementById('water-frequency');
    const sunlightField = document.getElementById('sunlight-hours');
    const soilField = document.getElementById('soil-type');
    let debounceTimer;
    let isDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDark);

    if (isDarkMode) htmlEl.classList.add('dark');

    window.toggleDarkMode = function () {
        isDarkMode = !isDarkMode;
        if (isDarkMode) {
            htmlEl.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            htmlEl.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
        // Assuming lucide is loaded and needed for icon updates
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    };

    // --- 1. FORM SUBMIT HANDLER (Attached only ONCE) ---
    const formEl = document.getElementById('add-plant-form');
    if (formEl) {
        formEl.addEventListener('submit', (e) => {
            e.preventDefault(); 

            const payload = {
                id: Date.now(), 
                nickname: document.getElementById('nickname')?.value?.trim() || '',
                species: document.getElementById('species-search')?.value?.trim() || '',
                water_frequency: document.getElementById('water-frequency')?.value || '',
                last_watered: document.getElementById('last-watered')?.value || '',
                
                // Assuming you have an element with ID 'sunlight-select'
                sunlight_note: document.getElementById('sunlight-select')?.value || '', 
                location: document.getElementById('location')?.value?.trim() || '',
                notes: document.getElementById('notes')?.value?.trim() || ''
            };
            document.getElementById('save-button')?.addEventListener('click', (e) => {
            e.preventDefault();
            const formEl = document.getElementById('add-plant-form') || document.querySelector('form');
            
            if (formEl?.requestSubmit) formEl.requestSubmit();
            else formEl?.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            });

            const existing = JSON.parse(localStorage.getItem('my_plants') || '[]');
            existing.push(payload);
            localStorage.setItem('my_plants', JSON.stringify(existing));
            
            // Redirect to the dashboard
            window.location.href = '/dashboard'; 
        });
    }

    // --- 2. SEARCH INPUT HANDLER (Attached only ONCE for debounced fetching) ---
    if (searchField) {
        searchField.setAttribute('autocomplete', 'off'); 

        searchField.addEventListener('input', (event) => {
            clearTimeout(debounceTimer);
            const query = event.target.value.trim();
            if (query.length < 2) {
                plantList.innerHTML = '';
                const box = document.getElementById('plant-suggestions');
                if (box) { box.classList.add('hidden'); box.innerHTML = ''; }
                return;
            }

            debounceTimer = setTimeout(async () => {
                const currentQuery = query;
                try {
                    const res = await fetch('/api/plants/search?q=' + encodeURIComponent(query));
                    if (!res.ok) return;
                    const plants = await res.json();
                    
                    // Fallback stub for testing if DB is empty
                    if (!plants.length) { console.log('Using stub'); plants.push({name: 'Monstera'}, {name: 'Corn'}); }
                    
                    if (searchField.value.trim() !== currentQuery) return;
                    console.log('search', query, 'results', plants.length, plants.slice(0, 3));

                    // Populate datalist
                    plantList.innerHTML = plants.map(p => `
                        <option value="${p.name}"
                                data-water="${p.water_frequency || ''}"
                                data-sunlight="${p.sunlight_hours || ''}"
                                data-soil="${p.soil_type || ''}">
                        </option>
                    `).join('');
                    const parent = plantList.parentNode;
                    parent.removeChild(plantList); 
                    parent.appendChild(plantList);

                    // Custom suggestions dropdown
                    const box = document.getElementById('plant-suggestions');
                    if (box) {
                        if (!plants.length) { 
                            box.classList.add('hidden'); 
                            box.innerHTML = ''; 
                            return; 
                        }
                        box.innerHTML = plants.slice(0, 10).map(p => `
                            <button type="button" class="w-full text-left px-3 py-2 hover:bg-sage-green/10"
                                    data-name="${p.name}"
                                    data-water="${p.water_frequency || ''}"
                                    data-sunlight="${p.sunlight_hours || ''}"
                                    data-soil="${p.soil_type || ''}">
                                ${p.name}
                            </button>
                        `).join('');
                        box.classList.remove('hidden');
                    }
                } catch (e) {
                    console.warn('search error', e);
                }
            }, 200);
        });
        
        // --- 3. AUTO-FILL AND SUGGESTION CLICK HANDLERS (Must be outside the input handler) ---
        searchField.addEventListener('change', () => {
            const option = Array.from(plantList.options).find(opt => opt.value === searchField.value);
            const box = document.getElementById('plant-suggestions');
            if (box) { box.classList.add('hidden'); box.innerHTML = ''; }
            if (!option) return;
            if (option.dataset.water && waterField) waterField.value = option.dataset.water;
            if (option.dataset.sunlight && sunlightField) sunlightField.value = option.dataset.sunlight;
            if (option.dataset.soil && soilField) soilField.value = option.dataset.soil;
        });

        document.getElementById('plant-suggestions')?.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            searchField.value = btn.dataset.name || '';
            if (btn.dataset.water && waterField) waterField.value = btn.dataset.water;
            if (btn.dataset.sunlight && sunlightField) sunlightField.value = btn.dataset.sunlight;
            if (btn.dataset.soil && soilField) soilField.value = btn.dataset.soil;
            const box = document.getElementById('plant-suggestions');
            if (box) { box.classList.add('hidden'); box.innerHTML = ''; }
            searchField.dispatchEvent(new Event('change'));
        });
    }

    // --- 4. Stepper and Final Init Logic ---
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }

    // Stepper Logic (MVP - simple transition)
    let currentStep = 1;
    const totalSteps = 3;
    const formContainer = document.getElementById('plant-form-container');

    window.nextStep = function() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateFormView();
        }
    }

    window.prevStep = function() {
        if (currentStep > 1) {
            currentStep--;
            updateFormView();
        }
    }

    function updateFormView() {
        if (formContainer) {
            formContainer.style.transform = `translateX(-${(currentStep - 1) * 100}%)`;
        }
        document.querySelectorAll('.step-indicator').forEach((el, index) => {
            if (index < currentStep) {
                el.classList.add('bg-sage-green', 'text-forest-dark');
                el.classList.remove('bg-wood-light', 'dark:bg-wood-dark', 'text-gray-500');
            } else {
                el.classList.remove('bg-sage-green', 'text-forest-dark');
                el.classList.add('bg-wood-light', 'dark:bg-wood-dark', 'text-gray-500');
            }
        });
        
        // Button visibility
        document.getElementById('prev-button')?.classList.toggle('hidden', currentStep === 1);
        document.getElementById('next-button')?.classList.toggle('hidden', currentStep === totalSteps);
        document.getElementById('save-button')?.classList.toggle('hidden', currentStep !== totalSteps);
    }

    updateFormView(); // Initial setup
});

    </script>
</head>
<body class="bg-cream-light text-forest-text dark:bg-forest-dark dark:text-sage-light min-h-screen p-4">

    <header class="max-w-4xl mx-auto flex justify-between items-center h-16 mb-8">
        <a href="/dashboard" class="text-xl font-serif font-bold text-sage-green flex items-center space-x-2">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
            <span>Back to Dashboard</span>
        </a>
        <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-wood-light dark:hover:bg-wood-dark transition duration-300">
            <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
        </button>
    </header>

    <main class="max-w-4xl mx-auto bg-white dark:bg-forest-text p-6 sm:p-10 rounded-3xl shadow-soft dark:shadow-soft-dark border border-wood-light/50 dark:border-wood-dark/50 transition duration-500">
        <h1 class="text-3xl font-bold mb-2 text-forest-text dark:text-sage-light">Add a New Plant</h1>
        <p class="text-lg text-gray-500 dark:text-gray-400 mb-8">Let's get your new friend added to your collection.</p>

        <div class="flex justify-between items-center mb-10 relative">
            <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-wood-light dark:bg-wood-dark/50 -z-10"></div>
            
            <div class="flex flex-col items-center w-1/3">
                <span class="step-indicator w-8 h-8 flex items-center justify-center rounded-full font-bold transition-colors duration-300 text-sm">1</span>
                <span class="text-xs mt-1 text-forest-text dark:text-sage-light">Details</span>
            </div>

            <div class="flex flex-col items-center w-1/3">
                <span class="step-indicator w-8 h-8 flex items-center justify-center rounded-full bg-wood-light dark:bg-wood-dark text-gray-500 transition-colors duration-300 text-sm">2</span>
                <span class="text-xs mt-1 text-gray-500 dark:text-gray-400">Care Plan</span>
            </div>

            <div class="flex flex-col items-center w-1/3">
                <span class="step-indicator w-8 h-8 flex items-center justify-center rounded-full bg-wood-light dark:bg-wood-dark text-gray-500 transition-colors duration-300 text-sm">3</span>
                <span class="text-xs mt-1 text-gray-500 dark:text-gray-400">Photo & Finish</span>
            </div>
        </div>

        <form id="add-plant-form" class="overflow-hidden">
            <div id="plant-form-container" class="flex transition-transform duration-500 ease-in-out">

                
                <div class="w-full p-4 shrink-0 space-y-6">
                    <h2 class="text-2xl font-semibold text-sage-green mb-4">Step 1: Plant Details</h2>
                    
                    <div>
                        <label for="nickname" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Plant Nickname</label>
                        <div class="relative">
                            <i data-lucide="tag" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green"></i>
                            <input type="text" id="nickname" placeholder="e.g., 'Freddy the Ficus'" required class="w-full p-3 pl-10 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition">
                        </div>
                    </div>

                    <div>
                        <label for="species-search" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Species Lookup (Myriad of Species)</label>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green"></i>
                            <input type="text" id="species-search" name="species" list="plant-options" placeholder="Search for Monstera, Succulent, etc." required class="w-full p-3 pl-10 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition">
                            <datalist id="plant-options"></datalist>
                        <div id="plant-suggestions" class="absolute z-50 w-full mt-2 bg-white dark:bg-forest-text border border-wood-light dark:border-wood-dark rounded-xl max-h-40 overflow-y-auto shadow-sm"></div>

                        </div>
                        
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Selecting a species pre-fills the ideal care plan.</p>
                    </div>

                    <div>
                        <label for="location" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Location/Room</label>
                        <div class="relative">
                            <i data-lucide="home" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green"></i>
                            <input type="text" id="location" placeholder="e.g., Living Room Window" class="w-full p-3 pl-10 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition">
                        </div>
                    </div>
                </div>

                <div class="w-full p-4 shrink-0 space-y-6">
                    <h2 class="text-2xl font-semibold text-sage-green mb-4">Step 2: Define Care Plan</h2>

                    <div>
                        <label for="water-frequency" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Watering Frequency</label>
                        <div class="relative">
                            <i data-lucide="droplet" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green"></i>
                            <select id="water-frequency" class="w-full p-3 pl-10 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition appearance-none cursor-pointer">
                                <option value="" disabled selected>Select or use database default</option>
                                <option value="7">Once a week</option>
                                <option value="14">Every two weeks</option>
                                <option value="21">Every three weeks</option>
                                <option value="custom">Custom Schedule</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label for="last-watered" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Last Watered Date</label>
                        <div class="relative">
                            <i data-lucide="calendar" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-sage-green"></i>
                            <input type="date" id="last-watered" value="" class="w-full p-3 pl-10 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition">
                        </div>
                    </div>

                    <div>
                        <label for="notes" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Care Notes</label>
                        <textarea id="notes" rows="4" placeholder="Any special instructions or observations?" class="w-full p-3 border border-wood-light dark:border-wood-dark rounded-xl focus:ring-sage-green focus:border-sage-green dark:bg-forest-dark/50 dark:text-sage-light transition"></textarea>
                    </div>
                </div>

                <div class="w-full p-4 shrink-0 space-y-6">
                    <h2 class="text-2xl font-semibold text-sage-green mb-4">Step 3: Photo & Finish</h2>
                    
                    <div>
                        <label for="plant-photo" class="block text-sm font-medium mb-2 text-gray-700 dark:text-sage-light">Upload Plant Photo</label>
                        <div class="flex items-center space-x-4">
                            <div class="w-24 h-24 bg-wood-light dark:bg-wood-dark rounded-xl flex items-center justify-center border-2 border-dashed border-wood-dark/30 dark:border-sage-light/30">
                                <i data-lucide="image" class="w-8 h-8 text-gray-500 dark:text-gray-400"></i>
                            </div>
                            <input type="file" id="plant-photo" accept="image/*" class="text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sage-green/80 file:text-forest-dark hover:file:bg-sage-green transition duration-300">
                        </div>
                    </div>

                    <div class="pt-4 border-t border-wood-light dark:border-wood-dark/50">
                        <h3 class="text-xl font-semibold text-forest-text dark:text-sage-light mb-2">Ready to Grow?</h3>
                        <p class="text-gray-600 dark:text-gray-300">You're all set! Review your details and hit 'Add to Dashboard'.</p>
                    </div>

                    <div class="p-4 bg-wood-light/50 dark:bg-wood-dark/50 rounded-xl space-y-2 text-sm">
                        <p><strong>Nickname:</strong> <span id="summary-nickname">Freddy the Ficus (Mock)</span></p>
                        <p><strong>Species:</strong> <span id="summary-species">Ficus lyrata (Mock)</span></p>
                        <p><strong>Watering:</strong> <span id="summary-watering">Every two weeks (Mock)</span></p>
                    </div>

                </div>
            </div>
            <div class="flex justify-between mt-8 pt-6 border-t border-wood-light dark:border-wood-dark/50">
                <button id="prev-button" type="button" onclick="prevStep()" class="px-6 py-2 bg-wood-light dark:bg-wood-dark text-forest-text dark:text-sage-light font-semibold rounded-full hover:bg-wood-dark/30 dark:hover:bg-wood-dark/70 transition duration-300">
                    <i data-lucide="chevron-left" class="w-5 h-5 inline mr-1"></i>
                    Previous
                </button>
                <button id="next-button" type="button" onclick="nextStep()" class="px-6 py-2 bg-sage-green text-forest-dark font-bold rounded-full shadow-md hover:shadow-lg transition-all transform hover:scale-[1.02]">
                    Next Step
                    <i data-lucide="chevron-right" class="w-5 h-5 inline ml-1"></i>
                </button>
                <button id="save-button" type="submit" form="add-plant-form" class="hidden px-8 py-3 bg-sage-green text-forest-dark font-bold text-lg rounded-full shadow-md hover:shadow-xl transition-all transform hover:scale-[1.02]">
                    <i data-lucide="plus" class="w-5 h-5 inline mr-1"></i>
                    Add to Dashboard
                </button>
            </div>
        </form>
    </main>
</body>
</html>